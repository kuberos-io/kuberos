# Use NFS Server for Storage

To persistently store the data generated by the batch jobs, KubeROS supports different storage classes. For the self-hosted cluster at the edge, the easiest way is to set up an `NFS server` to provide persistent storage.

For batch jobs that are executed in the cloud, we recommend to use the storage services provided by the cloud provider.

To set up an NFS server, all you need is a machine running Linux on the same subnet as the cluster. 

Network File System (NFS) is a distributed file system protocol that allows you to share directories and files over a network. By default, the NFS protocol is not encrypted. You can restrict client IPs to prevent unauthorized access. 


## Setup NFS server
Firstly, intall the nfs server packages
```bash
sudo apt-get update
sudo apt-get install nfs-kernel-server

# Check the NFS version:
sudo cat /proc/fs/nfsd/versions
```

Create `root` directory:
```bash
sudo mkdir -p /srv/nfs4
```

Export the directory that is accessible by the clients
```bash
sudo nano /etc/exports

# add following lines
# NFS volume is only allowed to the clients from the predefined subnet.
/srv/nfs4      <subnet ip range: 192.168.10.0/24>(rw,no_subtree_check,no_root_squash)
```

# Export the file shares:
```bash
sudo exportfs -ar
```

## Setup cluster nodes
To access the NFS server, the `nfs-common` package need to be install on **each Kubernetes nodes**.
```bash
sudo apt-get update 
sudo apt-get install nfs-common
```

## Mount the file system on your local host
If you want to access the remote directory directly, you can mount it. 
```bash
# Create mount point:
sudo mkdir -p /data
# Mount
sudo mount -t nfs -o vers=4 <nfs-server ip>:<directory in server> <local mount point>
# Example:
sudo mount -f nfs -o vers4 192.168.11.32:/srv/nfs4 /data
```

## Quick check in Kubernetes
Use the `alpine` pod and create some files in the `/data` directory: 
```yaml
apiVersion: v1
kind: Pod
metadata:
  name: test-pod
spec:
  containers:
  - name: test-pod
    image: alpine
    command: ["/bin/ash", "-c", "trap : TERM INT; sleep infinity & wait"]
    volumeMounts:
        - name: nfs-volume
          mountPath: /data
  volumes:
    - name: nfs-volume
      nfs:
        server: <nfs server ip>
        path: /srv/nfs4
```

